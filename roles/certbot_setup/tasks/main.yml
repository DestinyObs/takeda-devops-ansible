
# Install Certbot and obtain/renew a single SSL certificate for all subdomains
- name: Install Certbot
  apt:
    name: certbot
    state: present

- name: Obtain/renew SSL cert for all subdomains
  command: >
    certbot certonly --nginx --non-interactive --agree-tos \
    --email {{ certbot_email }} \
    {% for domain in certbot_domains %}-d {{ domain }} {% endfor %}
  args:
    creates: "/etc/letsencrypt/live/{{ certbot_main_domain }}/fullchain.pem"

- name: Ensure Certbot auto-renewal
  cron:
    name: "Certbot renew"
    job: "certbot renew --quiet && systemctl reload nginx"
    minute: 0
    hour: 3
